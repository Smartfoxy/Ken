<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ken_Ken</title>
    <style>
        .container {
            width: 800px;
            height: 800px;
            background-color: lightblue;
            margin: 50px auto;
            display: flex;
            align-items: center;
            justify-content: space-around;
        }
        .table {
            border: 1px solid blue;
            padding: 15px;
        }
        td {
            border: 1px solid blue;
            padding: 5px;
            height: 20px;
            width: 20px;
            text-align: center;
        }
        table {
            border-collapse: collapse;
        }
        ._0 {
            background-color: red;
        }
        ._1 {
            background-color: yellow;
        }
        ._2 {
            background-color: green;
        }
        ._3 {
            background-color: blue;
        }
        ._4 {
            background-color: orange;
        }
        ._5 {
            background-color: lawngreen;
        }
        ._6 {
            background-color: lightcoral;
        }
        ._7 {
            background-color: rebeccapurple;
        }
        ._8 {
            background-color: tan;
        }
        ._9 {
            background-color: lightgray;
        }
        ._10 {
            background-color: brown;
        }
        ._11 {
            background-color: fuchsia;
        }
        ._12 {
            background-color: darkcyan;
        }
        ._13 {
            background-color: red;
        }
        ._14 {
            background-color: yellowgreen;
        }
        ._15 {
            background-color: aqua;
        }
        ._16 {
            background-color: yellow;
        }
        ._17 {
            background-color: green;
        }
        ._18 {
            background-color: blue;
        }
        ._19 {
            background-color: orange;
        }
        ._20 {
            background-color: lawngreen;
        }
        ._21 {
            background-color: lightcoral;
        }
        ._22 {
            background-color: rebeccapurple;
        }
        ._23 {
            background-color: tan;
        }
        ._24 {
            background-color: lightgray;
        }
        .bottom {
            border-bottom: 3px solid;
        }
        .right {
            border-right: 3px solid;    
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="table">
            <table></table>
        </div>
        
    </div>

    <script>
        "use strict"
        
        class Cell {
            constructor(row, col) {
                this.row = row;
                this.col = col;
                this.fill = false;
                this.union = false;
            }
            fillNum(num) {
                this.num = num;
                this.fill = true;
            }
            unionCells(unionIndex) {
                this.unionIndex = unionIndex;
                this.union = true;
            }
            addBorder(type) {
                this.border = type;
            }
        }

        class Union {
            constructor(index) {
                this.index = index;
                this.cellsInUnion = [];
            }
            addCellToUnion(cell) {
                this.cellsInUnion.push(cell);
            }
        }

        let repeate = 0; 
        const num = 9;
        //const maxCellsInUnion = 4;
        let indexOfUnion = 0;
        let arrOfUnions = [];

      

        let kenArr = createKen(num);
        fillKen(kenArr);

        console.log(kenArr);

        unionCells(kenArr);

        
        console.log(arrOfUnions);

        for(let i = 0; i < indexOfUnion/*num * num*/; i++) { //num*num нужно на чтото заменить??
            
            console.log(i, ': ');
            drawBordersOfUnion(arrOfUnions[i]);
        }

        drawTable(kenArr);


        function unionCells(arrOfCells) {
            for(let i = 0; i < arrOfCells.length; i++) {
                for(let j = 0; j < arrOfCells[i].length; j++) {
                    let x = i;
                    let y = j;
                    if(arrOfCells[x][y].union){
                        continue;
                    }
                    const countOfUnion = Math.round(Math.random() * (4 - 2) + 2); //2/3/4 сделать пропорцию 2/2/1 или считать кол-во 4
                    
                    console.log('count of union', countOfUnion);
                    let currentUnion = new Union(indexOfUnion);
                    for(let z = 0; z < countOfUnion; z++) {

                       if(z !== 0) {
                            let x1;
                            let y1;
                            let freeDirections = [1, 2, 3, 4];
                            let dir;
                            let att = 1;
                            do {
                                //let [x1, y1] = getNextCellcoordinates(x, y); что не так?
                                let arr = getNextCellcoordinates(x, y, freeDirections);
                                x1 = arr[0];
                                y1 = arr[1];
                                dir = arr[2];
                                console.log('direction^ ', dir);
                                freeDirections = freeDirections.filter(el => {
                                    //console.log(el);
                                    return (el !== dir);
                                });


                                console.log('attempt:', att , ', X: ',x, 'Y; ', y, 'X1: ',x1, 'Y1: ', y1, freeDirections);
                                //console.log(!isCellExistAndFree($table, x1, y1));
                                att++;
                            } while (!isCellExistAndFree(arrOfCells, x1, y1));
                             //destraction!!!!
                            x = x1;
                            y = y1;
                        }

                        console.log(indexOfUnion);

                        arrOfCells[x][y].unionCells(indexOfUnion);
                        currentUnion.addCellToUnion(arrOfCells[x][y]);
                        
                        

                        //console.log('X: ' + x, 'Y: ' + y, $table.rows[x].cells[y].className);

                        if(!isFreeNeighborCellExist(arrOfCells, x, y)) {
                            console.log('break');
                            break;
                        }

                    }
                    arrOfUnions.push(currentUnion);
                    indexOfUnion++;
                }
            }
        }

        function getNextCellcoordinates(x, y, freeDirections) {
            /*for(let i =0; i < freeDirections.length; i++) {
                console.log('dir:', freeDirections[i]);
            }*/
            let arrCoordinates = [];
            const index =  Math.round(Math.random() * (freeDirections.length - 1));
            const direction = freeDirections[index];
            switch (direction) {
                case 1 :
                    y++;
                    break;
                case 2 :
                    x++;
                    break;
                case 3 :
                    y--;
                    break;
                case 4 : 
                    x--;
                    break;
                default:
                    alert('упс!') //нужно ли здесь дефолт обязательно?
            }
            arrCoordinates[0] = x;
            arrCoordinates[1] = y;
            arrCoordinates[2] = direction;
            return arrCoordinates;
        }

        function drawBordersOfUnion(union) {
            const cells = union.cellsInUnion;
            
            let arrOfRows = [];
            for(let i = 0; i < cells.length; i++) {
                arrOfRows.push(cells[i].row);
            }
            arrOfRows.sort();
            console.log(arrOfRows);

            for(let row = arrOfRows[0]; row <= arrOfRows[arrOfRows.length-1]; row++) {
                let currentRow = cells.filter(el => {
                    return el.row === row;
                })
                console.log('row #', row, ': ', currentRow);

                for(let i = 0; i < currentRow.length - 1; i++) {
                    for(let j = i + 1; j < currentRow.length; j++){
                        if(currentRow[i].col > currentRow[j].col) {
                            let buf = currentRow[i];
                            currentRow[i] = currentRow[j];
                            currentRow[j] = buf;
                        }
                    }
                }

                currentRow[currentRow.length - 1].addBorder('right');

                // 

                /*for(let i = 0; i < cells.length; i++) {
                let currentRow = cells[i].row;
                if(!arrOfRows.find(el => {
                    return el === currentRow;
                })) {
                    arrOfRows.push(currentRow);
                }
            }*/
            }
        }


        function isCellExist(arrOfCells, x, y) {
            return (x >= 0 && x < arrOfCells.length) && (y >= 0 && y < arrOfCells.length);
        }
        function isCellFree(arrOfCells, x, y) {
            return !arrOfCells[x][y].union;
        }
        function isCellExistAndFree(arrOfCells, x, y) {
            return isCellExist(arrOfCells, x, y) && isCellFree(arrOfCells, x, y);
        }
        function isFreeNeighborCellExist(arrOfCells, x, y) {
            return isCellExistAndFree(arrOfCells, x + 1, y) || isCellExistAndFree(arrOfCells, x - 1, y) || isCellExistAndFree(arrOfCells, x, y + 1) || isCellExistAndFree(arrOfCells, x, y - 1);
        }
        
        

        

       /* const $table = document.querySelector('table');
        
        unionCells($table, kenArr);

        */




       

        function createKen(num) {
            let kenArr = [];
            for(let i = 0; i < num; i++) {
                let rowArr = [];
                for(let j = 0; j < num; j++) {
                    rowArr.push(new Cell(i, j));
                }
                kenArr.push(rowArr);
            }
            return kenArr;
        }

        function fillKen(kenArr) {
            const length = kenArr.length;
            for(let i = 1; i <= length; i++) {
                
                for(let j = 0; j < length; j++) {
                    let emptyCellInRow = kenArr[j].filter(function(cell) {
                        return !cell.fill;
                    })
                    let restCellForFill = emptyCellInRow.filter(function(el) {
                        let result = true;
                        for(let z = 0; z < j; z++) {
                            if(kenArr[z][el.col].num === i) result = false;
                        }
                        return result;
                    })
                   
                    if(!restCellForFill.length) {
                        repeate++;
                        for(let z = 0; z < j; z++) {
                            kenArr[z].forEach(el => {
                                if(el.num === i) {
                                    el.num = null;
                                    el.fill = false;
                                }
                            });
                        }

                        j = -1;
                        continue;
                    }   
                    
                    //console.log(j, restCellForFill);
                    let col = Math.round(Math.random() * (restCellForFill.length - 1));
                    let currentCell = restCellForFill[col];
                    currentCell.fillNum(i);
                    for(let i = 0; i < length; i++) {
                        let result = '';
                        for(let j = 0; j < length; j++){
                            let cur = kenArr[i][j].num ? kenArr[i][j].num : 0;
                            result += cur + " ";
                        }
                        //console.log(result); 
                    }
                    
                }

            }
        }

        function drawTable(arrObj) {
            const $table = document.querySelector('table');
            let inner = '';
            for(let i = 0; i < arrObj.length; i++) {
                let row = '<tr>';
                    for(let j = 0; j < arrObj[i].length; j++) {
                        const border = arrObj[i][j].border ? arrObj[i][j].border : '';
                            row += `<td class = 'cell _${arrObj[i][j].unionIndex} ${border}'>${arrObj[i][j].num}</td>`;
                        
                        
                    }
                row += '</tr>';    
                inner += row;
            }

            $table.innerHTML = inner;
        }

         /* let maxOfFour = 1;
        switch(num) {
            case 6 :
                maxOfFour = 2;
                break;
            case 7 :
                maxOfFour = 3;
                break;
            case 8 :
                maxOfFour = 3;
                break;
            case 9 : 
                maxOfFour = 4;
                break;
            default:
                alert('упсcccc!')
        }*/

        

       
    </script>

    
</body>
</html>